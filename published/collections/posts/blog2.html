<!doctype html>

<html lang="en">

	<head>

    <meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="description" content="The blog page">



<title>Rui.X's Collections-Set up Ubuntu 14.04 Server</title>

	<script src="../js/jquery-2.1.4.min.js"></script>

	<script src="../js/jquery-ui.min.js"></script>



	<!-- Latest compiled and minified CSS -->

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">



	<!-- Optional theme -->

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">



	<!-- Latest compiled and minified JavaScript -->

	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>







    <link rel="stylesheet" href="../css/classification.css">



    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/default.min.css">

    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>

    <script>

	$(document).ready(function() {

	$('code').each(function(i, block) {

		hljs.highlightBlock(block);

		

	});

	});

    </script>



</head>


	<body>

<div id="layout">

	
    <div class="navigator">
	<nav class="mdnav navbar navbar-default">
	<div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
        <div class="navlogo">
        <a href="../../index.html">Homepage</a>
        </div>
		<div id="navbar" class="navbar-collapse collapse" aria-expanded="false" style="height: 1px;">
			<ul class="sections nav navbar-nav">
				<li class="section-term"><a href="../../blog/index.html">blog</a></li>
<li class="section-term md-inactive"><a href="../../collections/index.html">collections</a></li>
<li class="section-term"><a href="../../aboutme/index.html">about me</a></li>
			</ul>
		</div>
	</div>
	</nav>
    </div>


    <div class="cover">

	    
<div class="container">
        <h1><a class="" href="../index.html">Rui.X's Collections</a></h1>
        <p></p>
</div>
<div class="subnav container">
<ul>
        
<li class="dropdown mdnav"><a href="#" class="dropdown-toggle" data-toggle="dropdown">
by TAG
<span class="caret"></span></a>

<ul class="dropdown-menu" role="menu">
<li><a href="../index.html">All</a></li>
<li><a href="../tag1.html"> vpn</a></li>
<li><a href="../tag2.html">OSX</a></li>
<li><a href="../tag3.html">Octopress</a></li>
<li><a href="../tag4.html">Ubuntu</a></li>
</ul>

</li>


<li class="dropdown mdnav"><a href="#" class="dropdown-toggle" data-toggle="dropdown">
by YEAR
<span class="caret"></span></a>

<ul class="dropdown-menu" role="menu">
<li><a href="../index.html">All</a></li>
<li><a href="../year1.html">2015</a></li>
</ul>

</li>


<li class="dropdown mdnav"><a href="#" class="dropdown-toggle" data-toggle="dropdown">
by TOPIC
<span class="caret"></span></a>

<ul class="dropdown-menu" role="menu">
<li><a href="../index.html">All</a></li>
<li><a href="../topic1.html">manual</a></li>
</ul>

</li>

</ul>
</div>


    </div>



    <div class="content">

    <div class="container">

	    <section class="posts">

<h1 class="content-subhead">Ubuntu</h1>



<header class="post-header">



<h2 class="post-title">Set up Ubuntu 14.04 Server</h2>



<p class="post-meta">

Posted in 2015-01-01 15:00





<div class="post-content">

	<p>

	<h2>Netwoks</h2>

<ol>
<li>Config /etc/network/interface. <br />
Here's a <a href="files/conf/interface">sample file</a>.</li>
<li>Start up wlan0:</li>
</ol>

<div class="codehilite"><pre><code>sudo ifup wlan0
</code></pre></div>

<h2>Install vim, zsh, tmux, git</h2>

<p>Refer to the part in my wiki on <a href="ubuntu12.md#install_git,_vim,_tmux_and_omyzsh">set up Ubuntu 12.04</a>.</p>

<h2>Dynamic DNS</h2>

<p>I currently use <a href="http://hsk.oray.com/">花生壳</a> to build up dynamic ddns. Dowload the phddns file and install it:</p>

<div class="codehilite"><pre><code>./configure
make
</code></pre></div>

<p>Then check <em>src/phddns</em>. If it works, you can create its startup on boot. For me, my service script is simply:</p>

<div class="codehilite"><pre><code><span class="c">#!/bin/sh</span>
<span class="c"># Starts and stops phddns  </span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
start<span class="o">)</span>
    /opt/phddns/src/phddns &gt; /dev/null <span class="p">&amp;</span>
<span class="p">;;</span>
stop<span class="o">)</span>
<span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div>

<h2>VPN</h2>

<p>To set up a VPN server, I followed <a href="https://help.ubuntu.com/community/L2TPServer">this documentation</a>.</p>

<ol>
<li>Install xl2tpd openswan ppp:</li>
</ol>

<div class="codehilite"><pre><code>sudo apt-get install xl2tpd openswan ppp
</code></pre></div>

<p>for raspbian, also lsof should be installed:</p>

<div class="codehilite"><pre><code>sudo apt-get install lsof
</code></pre></div>

<p>note that newest openswan 
<code>
1:2.6.37-3+deb7u1
</code> </p>

<p>doesn't work, so you should manually install the downgraded version:</p>

<div class="codehilite"><pre><code>wget http://snapshot.raspbian.org/201403301125/raspbian/pool/main/o/openswan/openswan_2.6.37-3_armhf.deb
sudo dpkg -i openswan_2.6.37-3_armhf.deb
</code></pre></div>

<ol>
<li><p>Configure the following files (samples in my case):</p>

<ul>
<li>/etc/ipsec.conf</li>
</ul>

<pre><code>config setup
    nat_traversal=yes
    virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!10.152.2.0/24
    #contains the networks that are allowed as subnet= for the remote client. In other words, the address ranges that may live behind a NAT router through which a client connects.
    oe=off
    protostack=netkey  
conn L2TP-PSK-NAT
    rightsubnet=vhost:%priv
    also=L2TP-PSK-noNAT  
conn L2TP-PSK-noNAT
    authby=secret
    pfs=no
    auto=add
    keyingtries=3
    rekey=no
    # Apple iOS doesn't send delete notify so we need dead peer detection
    # to detect vanishing clients
    dpddelay=30
    dpdtimeout=120
    dpdaction=clear
    # Set ikelifetime and keylife to same defaults windows has
    ikelifetime=8h
    keylife=1h
    type=transport
    # Replace IP address with your local IP (private, behind NAT IP is okay as well)
    left=192.168.0.7
    # For updated Windows 2000/XP clients,
    # to support old clients as well, use leftprotoport=17/%anyhjjkk
    leftprotoport=17/%any
    right=%any
    rightprotoport=17/%any
    #force all to be nat'ed. because of iOS
    forceencaps=yes
</code></pre>

<ul>
<li>The startup script in /etc/init.d/</li>
</ul>

<div class="codehilite"><pre><code><span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
start<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Starting my Ipsec VPN&quot;</span>
iptables  -t nat   -A POSTROUTING -o eth0 -s 10.152.2.0/24 -j MASQUERADE
<span class="nb">echo </span><span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
<span class="k">for</span> each in /proc/sys/net/ipv4/conf/*
<span class="k">do</span>
    <span class="nb">echo </span><span class="m">0</span> &gt; <span class="nv">$each</span>/accept_redirects
    <span class="nb">echo </span><span class="m">0</span> &gt; <span class="nv">$each</span>/send_redirects
<span class="k">done</span>
/etc/init.d/ipsec start
/etc/init.d/xl2tpd start
<span class="p">;;</span>
stop<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Stopping my Ipsec VPN&quot;</span>
iptables --table nat --flush
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/ip_forward
/etc/init.d/ipsec stop
/etc/init.d/xl2tpd stop
<span class="p">;;</span>
restart<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Restarting my Ipsec VPN&quot;</span>
iptables  -t nat   -A POSTROUTING -o eth0 -s 10.152.2.0/24 -j MASQUERADE
<span class="nb">echo </span><span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
<span class="k">for</span> each in /proc/sys/net/ipv4/conf/*
<span class="k">do</span>
    <span class="nb">echo </span><span class="m">0</span> &gt; <span class="nv">$each</span>/accept_redirects
    <span class="nb">echo </span><span class="m">0</span> &gt; <span class="nv">$each</span>/send_redirects
<span class="k">done</span>
/etc/init.d/ipsec restart
/etc/init.d/xl2tpd restart  
<span class="p">;;</span>
*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Usage: /etc/init.d/ipsec.vpn  {start|stop|restart}&quot;</span>
<span class="nb">exit </span>1
<span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div>

<ul>
<li>/etc/ipsec.secret</li>
</ul>

<pre><code>%any: PSK "some key here"
</code></pre>

<ul>
<li>/etc/xl2tpd/xl2tpd.conf</li>
</ul>

<pre><code>[global]
ipsec saref = no  
[lns default]
ip range = 10.152.2.2-10.152.2.254
local ip = 10.152.2.1
require chap = yes
refuse pap = yes
require authentication = yes
ppp debug = yes
pppoptfile = /etc/ppp/options.xl2tpd
length bit = yes
</code></pre>

<ul>
<li>/etc/ppp/options.xl2tpd</li>
</ul>

<pre><code>refuse-mschap-v2
refuse-mschap
ms-dns 8.8.8.8
ms-dns 8.8.4.4
asyncmap 0
auth
crtscts
idle 1800
mtu 1200
mru 1200
lock
hide-password
local
#debug
name l2tpd
proxyarp
lcp-echo-interval 30
lcp-echo-failure 4
</code></pre>

<ul>
<li>In /etc/ppp/chap-secrets, set the users and passwords:</li>
</ul>

<pre><code>user1 l2tpd chooseagoodpassword *
</code></pre>

<ul>
<li>In /etc/sysctl.conf</li>
</ul>

<div class="codehilite"><pre><code>net.ipv4.ip_forward<span class="o">=</span>1
</code></pre></div></li>
<li><p>Add following lines to run when boot up, using either rc.local or service:</p>

<div class="codehilite"><pre><code><span class="c"># Disable send redirects</span>
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/all/send_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/default/send_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/lo/send_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/wlan0/send_redirects  
<span class="c"># Disable accept redirects</span>
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/all/accept_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/default/accept_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/eth0/accept_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/lo/accept_redirects
<span class="nb">echo </span><span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/wlan0/accept_redirects  
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -I FORWARD -p tcp --syn -i ppp+ -j TCPMSS --set-mss 1356
</code></pre></div></li>
</ol>

<h2>Nginx, myhomepage, MDWiki, and Octopress</h2>

<h3>Nginx</h3>

<p>Install it using apt-get</p>

<div class="codehilite"><pre><code>sudo apt-get install nginx
</code></pre></div>

<p>Then config <em>/etc/nginx/sites-enabled/default</em>, which in my case:</p>

<pre><code>server {
        listen 80;  
        root /home/arsread/homepage/;
        index index.html index.htm;  
        location /wiki {
                alias /home/arsread/mdwiki/;
                #index index.html;
        }  
        location /blog {
                root /home/arsread/myblog/public/;
                #index index.html;
        }
        ......
}
</code></pre>

<h2>Laptop mode</h2>

<p>Laptop mode is a tool in Ubuntu allowing lower battery consumption. Install it by:</p>

<div class="codehilite"><pre><code>sudo add-apt-repository ppa:webupd8team/unstable
sudo apt-get update
sudo apt-get install laptop-mode-tools
</code></pre></div>

<p>And remember to enable following options in <em>/etc/laptop-mode/laptop-mode.conf</em>:</p>

<pre><code>ENABLE_LAPTOP_MODE_ON_AC=1
ENABLE_LAPTOP_MODE_ON_BATTERY = 1
</code></pre>

<p>Then restart the service.</p>

<h2>Configure behaviour when closing the lid</h2>

<p>Modify <em>/etc/systemd/logind.conf</em>:</p>

<div class="codehilite"><pre><code><span class="nv">HandleLidSwitch</span><span class="o">=</span>ignore
</code></pre></div>

<p>Then restart.</p>

<h2>Rtcwake and crontab</h2>

<p>Rtcwake is a Linux command to put the computer into sleep or hibernation for a fixed time. Combine it with crontab, we can schedule the computer to work and rest regularly:</p>

<div class="codehilite"><pre><code>sudo crontab -e
</code></pre></div>

<p>Documents for crontab and rtcwake can be easily found online. In my case:</p>

<pre><code>0 20 * * * rtcwake -m disk -s 28800
30 8 * * * reboot
</code></pre>

<h2>Update grub</h2>

<p>Ocationnally grub boot menu would lost its countdown. In my case, it's because some failure in rebooting. I had a workaround it by changeing the following line in <em>/etc/grub.d/00_header</em></p>

<div class="codehilite"><pre><code><span class="nb">set </span><span class="nv">timeout</span><span class="o">=</span><span class="si">${</span><span class="nv">GRUB_RECORDFAIL_TIMEOUT</span><span class="k">:-</span><span class="p">-1</span><span class="si">}</span>
</code></pre></div>

<p>into</p>

<div class="codehilite"><pre><code><span class="nb">set </span><span class="nv">timeout</span><span class="o">=</span>0
</code></pre></div>

<p>Then run</p>

<div class="codehilite"><pre><code>sudo update-grub
</code></pre></div>

<p>To update related files.</p>


	</p>

</div>



<div class="footer">
<div class="leftfooter"><a href="blog1.html"> Previous:Connect to my VPN Server based on L2TP/IPsec</a></div>
<div class="rightfooter"><a href="blog3.html"> Next:Installation and configuration on Ubuntu 12.04 LTS Desktop</a></div>
</div>

</section>


    </div>

    </div>

</div>

</body>


</html>
